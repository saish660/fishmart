<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Find Stores - Amcho Pasro</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <!-- MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='products.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='location-picker.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='store-finder.css') }}"
    />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <a href="{{ url_for('index') }}" class="brand-link">Amcho Pasro</a>
        </div>
        <ul class="navbar-menu">
          {% if current_user.is_authenticated %}
          <li class="navbar-item">
            <a href="{{ url_for('products') }}" class="navbar-link">Products</a>
          </li>
          <li class="navbar-item">
            <a href="{{ url_for('store_finder') }}" class="navbar-link active"
              >Find Stores</a
            >
          </li>
          {% if current_user.is_seller() %}
          <li class="navbar-item">
            <a href="{{ url_for('post_product') }}" class="navbar-link"
              >Post Product</a
            >
            <li class="navbar-item">
              <a href="{{ url_for('my_store') }}" class="navbar-link">My Store</a>
            </li>
          </li>
          {% endif %}
          <li class="navbar-item">
            <a href="{{ url_for('logout') }}" class="navbar-link">Logout</a>
          </li>
          {% else %}
          <li class="navbar-item">
            <a href="{{ url_for('index') }}" class="navbar-link">Home</a>
          </li>
          <li class="navbar-item">
            <a href="{{ url_for('products') }}" class="navbar-link">Products</a>
          </li>
          <li class="navbar-item">
            <a href="{{ url_for('login') }}" class="navbar-link">Login</a>
          </li>
          <li class="navbar-item">
            <a href="{{ url_for('signup') }}" class="navbar-link">Sign Up</a>
          </li>
          <li class="navbar-item">
            <a href="{{ url_for('seller_signup') }}" class="navbar-link"
              >Join as Seller</a
            >
          </li>
          {% endif %}
        </ul>
        <div class="mobile-menu-toggle" id="mobile-menu-toggle">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </div>
      </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar" id="mobile-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">Amcho Pasro</div>
        <button class="sidebar-close" id="sidebar-close">&times;</button>
      </div>
      <ul class="sidebar-menu">
        {% if current_user.is_authenticated %}
        <li class="sidebar-item">
          <a href="{{ url_for('products') }}" class="sidebar-link">Products</a>
        </li>
        <li class="sidebar-item">
          <a href="{{ url_for('store_finder') }}" class="sidebar-link active"
            >Find Stores</a
          >
        </li>
        {% if current_user.is_seller() %}
        <li class="sidebar-item">
          <a href="{{ url_for('post_product') }}" class="sidebar-link"
            >Post Product</a
          >
          <li class="sidebar-item">
            <a href="{{ url_for('my_store') }}" class="sidebar-link">My Store</a>
          </li>
        </li>
        {% endif %}
        <li class="sidebar-item">
          <a href="{{ url_for('logout') }}" class="sidebar-link">Logout</a>
        </li>
        {% else %}
        <li class="sidebar-item">
          <a href="{{ url_for('index') }}" class="sidebar-link">Home</a>
        </li>
        <li class="sidebar-item">
          <a href="{{ url_for('products') }}" class="sidebar-link">Products</a>
        </li>
        <li class="sidebar-item">
          <a href="{{ url_for('login') }}" class="sidebar-link">Login</a>
        </li>
        <li class="sidebar-item">
          <a href="{{ url_for('signup') }}" class="sidebar-link">Sign Up</a>
        </li>
        <li class="sidebar-item">
          <a href="{{ url_for('seller_signup') }}" class="sidebar-link"
            >Join as Seller</a
          >
        </li>
        {% endif %}
      </ul>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="page-wrapper">
      <section class="page-hero store-finder-hero">
        <div class="page-hero__inner store-finder-hero__inner">
          <div class="store-finder-hero__copy">
            <span class="page-hero__eyebrow">Store locator</span>
            <h1 class="page-hero__title">Find fresh catches near you</h1>
            <p class="page-hero__subtitle">
              Discover community-run fish markets, locate them on the live map,
              and plan your visit with distance hints and rich store cards.
            </p>
            <ul class="finder-hero-list">
              <li><strong>{{ stores|length }}</strong> verified stores on the map</li>
              <li>Search by area or filter by store name</li>
              <li>Tap a card to jump straight to the store page</li>
            </ul>
            <div class="page-hero__actions">
              <a href="#finder" class="btn-secondary">Open the map</a>
              <a href="{{ url_for('products') }}" class="btn-ghost">Browse marketplace</a>
            </div>
          </div>
          <div class="store-finder-hero__visual">
            <div class="finder-hero-card">
              <span class="finder-hero-card__label">Live stores</span>
              <span class="finder-hero-card__value">{{ stores|length }}</span>
              <p class="finder-hero-card__meta">Curated by the Amcho Pasro community</p>
            </div>
          </div>
        </div>
      </section>

      <section class="section-block finder-section" id="finder">
        <div class="page-shell finder-shell">
          <div class="finder-layout">
            <aside class="finder-panel surface-card surface-card--quiet">
              <div class="finder-panel__header">
                <h2>Plan your visit</h2>
                <p>
                  Use the search tools below to zero in on a neighbourhood and get real-time coordinates for precise directions.
                </p>
              </div>
              <form class="finder-form" onsubmit="return false;" autocomplete="off">
                <div class="finder-form__group">
                  <label for="finder-search">Search an area</label>
                  <div class="finder-form__field">
                    <input
                      id="finder-search"
                      class="finder-input"
                      type="text"
                      placeholder="Try Margao, Panjim, Vasco..."
                      list="finderSuggestions"
                    />
                    <datalist id="finderSuggestions"></datalist>
                  </div>
                  <small>Powered by OpenStreetMap search.</small>
                </div>

                <div class="finder-form__actions">
                  <button id="finder-detect" class="btn-secondary" type="button">
                    Use My Location
                  </button>
                  <button id="finder-reset" class="btn-ghost" type="button">
                    Reset View
                  </button>
                </div>

                <div class="finder-form__group">
                  <label for="store-name-filter">Filter by store name</label>
                  <div class="finder-form__field">
                    <input
                      id="store-name-filter"
                      class="finder-input"
                      type="text"
                      placeholder="e.g. Mandovi Fishers"
                      aria-label="Search stores by name"
                    />
                  </div>
                </div>
              </form>

              <div class="finder-tips">
                <h3>Quick tips</h3>
                <ul>
                  <li>Pan the map or pinch on mobile to explore everything around you.</li>
                  <li>Click any marker to open a store preview and jump to its page.</li>
                  <li>Reset view to refocus on the full coastline whenever you're done.</li>
                </ul>
              </div>
            </aside>

            <div class="finder-map-card glassy-panel">
              <div class="finder-map-card__header">
                <h2>Interactive map</h2>
                <p>All stores plotted with clustering for faster browsing.</p>
              </div>
              <div
                id="stores-map"
                class="map-container"
                aria-label="Map with store locations"
                data-stores="{{ stores | tojson }}"
              ></div>
              <div id="stores-readout" class="map-readout">
                <dl>
                  <div class="map-readout__item">
                    <dt>Latitude</dt>
                    <dd id="center-lat">—</dd>
                  </div>
                  <div class="map-readout__item">
                    <dt>Longitude</dt>
                    <dd id="center-lng">—</dd>
                  </div>
                  <div class="map-readout__item map-readout__item--full">
                    <dt>Approx. area</dt>
                    <dd id="center-addr">—</dd>
                  </div>
                </dl>
              </div>
            </div>
          </div>

          <div class="finder-results surface-card surface-card--quiet">
            <div class="finder-results__header">
              <div>
                <h2>Stores nearby</h2>
                <p>
                  These cards sync with the map above. Distances update automatically when you search for a new area.
                </p>
              </div>
            </div>
            <div id="store-cards" class="products-grid finder-cards"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
      defer
    ></script>
    <!-- MarkerCluster JS -->
    <script
      src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
      defer
    ></script>
    <!-- Inject stores data globally as a robust fallback -->
    <script>
      window.AMCHO_PASRO_STORES = {{ stores | tojson }};
    </script>
    <script
      src="{{ url_for('static', filename='store-finder.js') }}"
      defer
    ></script>
    <script src="{{ url_for('static', filename='main.js') }}" defer></script>
  </body>
</html>
